name: Deploy MakeMeLearn Unified

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # Tests de l'API avec PostgreSQL
  test-api:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: makemelearn_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup test database
        run: |
          echo "ğŸ—„ï¸ Configuration de la base de donnÃ©es de test..."
          
          # Attendre que PostgreSQL soit prÃªt
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U test_user; then
              echo "âœ… PostgreSQL prÃªt"
              break
            fi
            echo "Attente PostgreSQL... ($i/30)"
            sleep 2
          done
          
          # CrÃ©er les tables de test
          echo "ğŸ“‹ CrÃ©ation des tables de test..."
          PGPASSWORD=test_password psql -h localhost -p 5432 -U test_user -d makemelearn_test << 'EOF'
          -- Script d'initialisation simplifiÃ© pour les tests
          CREATE TABLE IF NOT EXISTS registrations (
              id SERIAL PRIMARY KEY,
              email VARCHAR(255) UNIQUE NOT NULL,
              source VARCHAR(100) DEFAULT 'website',
              metadata JSONB DEFAULT '{}',
              is_verified BOOLEAN DEFAULT false,
              verification_token VARCHAR(255),
              created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
              unsubscribed_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
          );

          CREATE TABLE IF NOT EXISTS stats (
              id SERIAL PRIMARY KEY,
              metric_name VARCHAR(100) NOT NULL,
              metric_value INTEGER DEFAULT 0,
              date DATE DEFAULT CURRENT_DATE,
              created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
              UNIQUE(metric_name, date)
          );

          -- Fonction pour incrÃ©menter les statistiques
          CREATE OR REPLACE FUNCTION increment_stat(stat_name VARCHAR(100), increment_value INTEGER DEFAULT 1)
          RETURNS void AS $$
          BEGIN
              INSERT INTO stats (metric_name, metric_value, date)
              VALUES (stat_name, increment_value, CURRENT_DATE)
              ON CONFLICT (metric_name, date)
              DO UPDATE SET 
                  metric_value = stats.metric_value + increment_value,
                  created_at = CURRENT_TIMESTAMP;
          END;
          $$ language 'plpgsql';

          -- InsÃ©rer quelques donnÃ©es de test
          INSERT INTO stats (metric_name, metric_value, date) VALUES 
              ('page_views', 0, CURRENT_DATE),
              ('api_calls', 0, CURRENT_DATE),
              ('registrations', 0, CURRENT_DATE)
          ON CONFLICT (metric_name, date) DO NOTHING;

          SELECT 'Tables crÃ©Ã©es avec succÃ¨s' as status;
          EOF
          
          echo "âœ… Base de donnÃ©es de test configurÃ©e"

      - name: Install API dependencies
        working-directory: ./api
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances API..."
          npm install
          
          # VÃ©rifier que les dÃ©pendances sont installÃ©es
          echo "âœ… DÃ©pendances installÃ©es:"
          npm list --depth=0 || echo "âš ï¸ Certaines dÃ©pendances peuvent Ãªtre manquantes"

      - name: Run API tests
        working-directory: ./api
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/makemelearn_test
        run: |
          echo "ğŸ§ª ExÃ©cution des tests API..."
          npm run test || echo "âš ï¸ Tests not configured yet - will be added later"
          npm run lint || echo "âš ï¸ Linting not configured yet - will be added later"

      - name: Test API startup and endpoints
        working-directory: ./api
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/makemelearn_test
          PORT: 3001
          CORS_ORIGIN: http://localhost:3001
          # Configuration email pour les tests (dÃ©sactivÃ©e pour les tests)
          EMAIL_PROVIDER: nodemailer
          SMTP_HOST: smtp.example.com
          SMTP_USER: test@example.com
          SMTP_PASS: fake_password
        run: |
          echo "ğŸš€ Test de dÃ©marrage de l'API..."
          
          # CrÃ©er le dossier logs pour les tests
          mkdir -p logs
          chmod 755 logs
          
          # CrÃ©er les dossiers nÃ©cessaires pour utils/logger
          mkdir -p src/utils
          touch src/utils/.gitkeep || true
          
          # DÃ©marrer l'API en arriÃ¨re-plan (ARCHITECTURE CORRIGÃ‰E)
          npm start &
          API_PID=$!
          
          # Fonction pour nettoyer en cas d'erreur
          cleanup() {
            echo "ğŸ§¹ Nettoyage..."
            kill $API_PID 2>/dev/null || true
            pkill -f "node.*server.js" 2>/dev/null || true
          }
          trap cleanup EXIT
          
          # Attendre que l'API dÃ©marre
          echo "ğŸ”„ DÃ©marrage de l'API..."
          API_STARTED=false
          for i in {1..45}; do
            if curl -f -s http://localhost:3001/health >/dev/null 2>&1; then
              echo "âœ… API dÃ©marrÃ©e avec succÃ¨s (tentative $i)"
              API_STARTED=true
              break
            fi
            echo "Attente dÃ©marrage API... ($i/45)"
            sleep 2
          done
          
          if [ "$API_STARTED" = "true" ]; then
            # Tester les endpoints critiques - ARCHITECTURE CORRIGÃ‰E
            echo "ğŸ§ª Test des endpoints..."
            
            # Test health check
            echo "Testing /health endpoint..."
            if curl -f -s http://localhost:3001/health; then
              echo "âœ… Health check OK"
            else
              echo "âŒ Health check failed"
              exit 1
            fi
            
            # Test stats endpoint public - ROUTE CORRIGÃ‰E (sans /api)
            echo "Testing /stats/public endpoint..."
            if curl -f -s http://localhost:3001/stats/public; then
              echo "âœ… Stats endpoint OK"
            else
              echo "âŒ Stats endpoint failed"
              exit 1
            fi
            
            # Test track endpoint - ROUTE CORRIGÃ‰E (sans /api)
            echo "Testing /stats/track endpoint..."
            if curl -f -s -X POST http://localhost:3001/stats/track \
                -H "Content-Type: application/json" \
                -d '{"event":"test_event","value":1}'; then
              echo "âœ… Track endpoint OK"
            else
              echo "âš ï¸ Track endpoint failed (non-blocking)"
            fi
            
            # Test registrations endpoint
            echo "Testing /registrations endpoint..."
            if curl -f -s -X POST http://localhost:3001/registrations \
                -H "Content-Type: application/json" \
                -d '{"email":"test@example.com","source":"ci_test"}'; then
              echo "âœ… Registrations endpoint OK"
            else
              echo "âš ï¸ Registrations endpoint failed (non-blocking)"
            fi
            
            # ğŸ”¥ NOUVEAU: Test contact endpoint
            echo "Testing /contact endpoint..."
            if curl -f -s -X POST http://localhost:3001/contact \
                -H "Content-Type: application/json" \
                -d '{"name":"Test User","email":"test@example.com","subject":"Test Subject","message":"This is a test message from CI/CD"}'; then
              echo "âœ… Contact endpoint OK"
            else
              echo "âš ï¸ Contact endpoint failed (expected - email not configured in tests)"
            fi
            
            # Test API root endpoint
            echo "Testing API root endpoint..."
            if curl -f -s http://localhost:3001/ | grep -q "MakeMeLearn API"; then
              echo "âœ… API root endpoint OK"
            else
              echo "âš ï¸ API root endpoint failed (non-blocking)"
            fi
            
            echo "ğŸ‰ Tous les tests d'endpoints sont passÃ©s!"
          else
            echo "âŒ API n'a pas pu dÃ©marrer dans les temps"
            echo "ğŸ“‹ Logs de debug:"
            jobs
            exit 1
          fi

  # Tests du frontend
  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install validation tools
        run: |
          echo "ğŸ“¦ Installation des outils de validation..."
          npm install -g html-validate
          npm install -g eslint

      - name: Validate HTML
        run: |
          echo "ğŸ” Validation HTML..."
          find . -name "*.html" -not -path "./node_modules/*" -not -path "./api/node_modules/*" | xargs html-validate

      - name: Validate JavaScript
        run: |
          echo "ğŸ” Validation JavaScript..."
          npx eslint script.js --no-eslintrc --config '{
            "env": { "browser": true, "es2021": true },
            "extends": "eslint:recommended",
            "rules": {
              "no-unused-vars": "warn",
              "no-undef": "warn"
            },
            "globals": {
              "console": "readonly",
              "fetch": "readonly",
              "document": "readonly",
              "window": "readonly",
              "navigator": "readonly"
            }
          }' || echo "âš ï¸ JS warnings detected but not blocking"

      - name: Check CSS syntax
        run: |
          echo "ğŸ” Validation CSS..."
          if find . -name "*.css" -not -path "./node_modules/*" | head -1 | read first_css; then
            # Compter les accolades pour vÃ©rifier la syntaxe de base
            OPEN=$(find . -name "*.css" -not -path "./node_modules/*" -exec grep -o "{" {} \; | wc -l)
            CLOSE=$(find . -name "*.css" -not -path "./node_modules/*" -exec grep -o "}" {} \; | wc -l)
            if [ "$OPEN" -ne "$CLOSE" ]; then
              echo "âŒ Erreur: accolades CSS non Ã©quilibrÃ©es ($OPEN ouvertures, $CLOSE fermetures)"
              exit 1
            fi
            echo "âœ… CSS syntax OK ($OPEN/{$CLOSE} accolades)"
          else
            echo "âš ï¸ Aucun fichier CSS trouvÃ©"
          fi

      - name: Check API configuration consistency
        run: |
          echo "ğŸ” VÃ©rification configuration API..."
          # VÃ©rifier que script.js utilise bien l'API config
          if grep -q "API_BASE_URL" script.js; then
            echo "âœ… API configuration trouvÃ©e dans script.js"
          else
            echo "âŒ Configuration API manquante dans script.js"
            exit 1
          fi
          
          # ğŸ”¥ NOUVEAU: VÃ©rifier que le contact form est bien configurÃ©
          if grep -q "/contact" script.js; then
            echo "âœ… Contact form API integration trouvÃ©e"
          else
            echo "âš ï¸ Contact form API integration manquante"
          fi

      - name: Check Contact Form Integration
        run: |
          echo "ğŸ” VÃ©rification intÃ©gration Contact Form..."
          
          # ğŸ”§ CORRECTION: VÃ©rifier que contact.html existe dans pages/
          if [ -f "pages/contact.html" ]; then
            echo "âœ… pages/contact.html trouvÃ©"
            
            # VÃ©rifier que le formulaire a les bons IDs
            if grep -q 'id="contactForm"' pages/contact.html; then
              echo "âœ… Contact form ID trouvÃ©"
            else
              echo "âŒ Contact form ID manquant"
              exit 1
            fi
            
            # VÃ©rifier que script.js gÃ¨re le contact form
            if grep -q "contactForm" script.js; then
              echo "âœ… Contact form handler trouvÃ© dans script.js"
            else
              echo "âŒ Contact form handler manquant dans script.js"
              exit 1
            fi
            
            # VÃ©rifier que les champs requis sont prÃ©sents
            required_fields=("name" "email" "subject" "message")
            missing_fields=()
            
            for field in "${required_fields[@]}"; do
              if ! grep -q "id=\"$field\"" pages/contact.html; then
                missing_fields+=("$field")
              fi
            done
            
            if [ ${#missing_fields[@]} -eq 0 ]; then
              echo "âœ… Tous les champs requis trouvÃ©s dans le formulaire"
            else
              echo "âŒ Champs manquants: ${missing_fields[*]}"
              exit 1
            fi
            
          else
            echo "âŒ pages/contact.html non trouvÃ©"
            echo "ğŸ“ Structure du dossier pages:"
            ls -la pages/ || echo "Dossier pages/ non trouvÃ©"
            exit 1
          fi

      - name: Check files structure
        run: |
          echo "ğŸ” VÃ©rification de la structure des fichiers..."
          echo "ğŸ“„ Fichiers HTML trouvÃ©s:"
          find . -name "*.html" -not -path "./node_modules/*" | head -10
          echo "ğŸ“„ Fichiers CSS trouvÃ©s:"
          find . -name "*.css" -not -path "./node_modules/*"
          echo "ğŸ“„ Fichiers JS trouvÃ©s:"
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./api/*"
          echo "ğŸ“ Contenu du dossier pages:"
          ls -la pages/ || echo "Dossier pages/ non trouvÃ©"

  # DÃ©ploiement sur le serveur (seulement sur push vers main)
  deploy:
    needs: [test-api, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          debug: false
          script: |
            echo "ğŸš€ Starting MakeMeLearn deployment..."

            # Variables
            PROJECT_DIR="$HOME/projects/makemelearn-landing"
            BACKUP_DIR="$HOME/backups/makemelearn"
            DATE=$(date +%Y%m%d_%H%M%S)

            # CrÃ©er les dossiers si nÃ©cessaire
            mkdir -p "$BACKUP_DIR"
            mkdir -p "$PROJECT_DIR/logs"

            # Aller dans le dossier du projet ou le crÃ©er
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“ CrÃ©ation du dossier projet..."
              mkdir -p ~/projects
              cd ~/projects
              git clone https://github.com/creach-t/makemelearn-landing.git
              cd makemelearn-landing
            else
              cd "$PROJECT_DIR"
            fi

            # Sauvegarder la configuration actuelle
            echo "ğŸ“¦ Sauvegarde de la configuration..."
            if [ -f ".env" ]; then
              cp .env "$BACKUP_DIR/.env.backup.$DATE"
              echo "âœ… .env sauvegardÃ©"
            fi

            # ArrÃªter les services avec timeout
            echo "â¹ï¸ ArrÃªt des services..."
            timeout 60 docker compose down --remove-orphans 2>/dev/null || {
              echo "âš ï¸ ArrÃªt forcÃ© des containers..."
              docker compose kill 2>/dev/null || true
              docker compose rm -f 2>/dev/null || true
            }

            # Mettre Ã  jour le code
            echo "ğŸ“¥ Mise Ã  jour du code..."
            git stash --include-untracked 2>/dev/null || true
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # VÃ©rifier/crÃ©er le fichier .env
            if [ ! -f ".env" ]; then
              echo "âš ï¸ Fichier .env manquant, copie depuis l'exemple..."
              cp .env.example .env
              echo "ğŸ”§ ATTENTION: Configurez le fichier .env avec vos vraies valeurs!"
            fi

            # CrÃ©er les dossiers nÃ©cessaires avec les bonnes permissions
            echo "ğŸ“ CrÃ©ation des dossiers nÃ©cessaires..."
            mkdir -p logs
            chmod 755 logs
            mkdir -p data

            # CrÃ©er le network Traefik si nÃ©cessaire
            echo "ğŸŒ VÃ©rification du network Traefik..."
            docker network create traefik-public 2>/dev/null || echo "â„¹ï¸ Network traefik-public existe dÃ©jÃ "

            # Construire et dÃ©marrer les services
            echo "ğŸ—ï¸ Construction et dÃ©marrage des services..."
            docker compose pull 2>/dev/null || echo "âš ï¸ Pull failed, using cached images..."
            
            # Build avec no-cache pour l'API pour s'assurer que les changements sont pris en compte
            docker compose build --no-cache api
            docker compose build frontend
            
            # DÃ©marrer les services
            docker compose up -d

            # Attente que les services soient prÃªts
            echo "â³ Attente que les services soient prÃªts..."
            sleep 15

            echo "ğŸ”„ VÃ©rification des containers..."
            
            # VÃ©rifier PostgreSQL
            if ! docker compose ps postgres | grep -q "Up"; then
              echo "âŒ Container PostgreSQL n'est pas dÃ©marrÃ©"
              exit 1
            fi
            echo "âœ… PostgreSQL: OK"

            # VÃ©rifier le frontend
            if ! docker compose ps frontend | grep -q "Up"; then
              echo "âŒ Container Frontend n'est pas dÃ©marrÃ©"
              exit 1
            fi
            echo "âœ… Frontend: OK"

            # VÃ©rifier l'API avec la mÃ©thode corrigÃ©e
            echo "ğŸ”„ Test du service API..."
            
            # D'abord vÃ©rifier que le container API est up
            if ! docker compose ps api | grep -q "Up"; then
              echo "âŒ Container API n'est pas dÃ©marrÃ©"
              exit 1
            fi

            # Tester l'API directement dans le container
            max_attempts=30
            attempt=1

            while [ $attempt -le $max_attempts ]; do
              echo "â³ Test de l'API (tentative $attempt/$max_attempts)..."
              
              # Test direct dans le container
              if docker compose exec -T api curl -f -s http://localhost:3000/health > /dev/null 2>&1; then
                echo "âœ… API rÃ©pond correctement sur le port interne"
                break
              elif [ $attempt -eq $max_attempts ]; then
                echo "âŒ API n'a pas dÃ©marrÃ© dans les temps"
                echo "ğŸ“‹ API Logs:"
                docker compose logs api --tail 50
                exit 1
              else
                echo "â³ API pas encore prÃªt (tentative $attempt/$max_attempts)..."
                sleep 2
              fi

              ((attempt++))
            done

            # Test optionnel de l'URL externe
            echo "ğŸŒ Test optionnel de l'URL externe..."
            if curl -f -s --max-time 10 "https://makemelearn.fr" > /dev/null 2>&1; then
              echo "âœ… Site accessible via https://makemelearn.fr"
            else
              echo "âš ï¸ Site pas encore accessible via l'URL externe (normal si Traefik n'est pas encore configurÃ©)"
            fi

            echo "âœ… DÃ©ploiement vÃ©rifiÃ© avec succÃ¨s"
            echo "ğŸ” Ã‰tat final des services..."
            docker compose ps

  # Tests post-dÃ©ploiement - ENDPOINTS CORRIGÃ‰S ET CONTACT AJOUTÃ‰
  post-deploy-tests:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Wait for services to be ready
        run: |
          echo "â³ Attente que les services soient complÃ¨tement prÃªts..."
          sleep 60

      - name: Test deployed services
        run: |
          echo "ğŸ” Test des services dÃ©ployÃ©s..."
          
          # Fonction pour tester une URL avec retry
          test_url() {
            local url=$1
            local name=$2
            local max_attempts=5
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ§ª Test $name (tentative $attempt/$max_attempts): $url"
              
              if curl -f -s -m 15 "$url" > /dev/null 2>&1; then
                echo "âœ… $name accessible"
                return 0
              elif [ $attempt -eq $max_attempts ]; then
                echo "âŒ $name non accessible aprÃ¨s $max_attempts tentatives"
                return 1
              else
                echo "â³ Nouvelle tentative dans 15s..."
                sleep 15
              fi
              
              ((attempt++))
            done
          }
          
          # Tests avec retry - TOUS LES ENDPOINTS
          ERROR=0
          
          test_url "https://makemelearn.fr" "Frontend" || ERROR=1
          test_url "https://makemelearn.fr/api/health" "API Health" || ERROR=1
          test_url "https://makemelearn.fr/api/stats/public" "API Stats" || ERROR=1
          
          # Test optionnel du tracking
          echo "ğŸ§ª Test optionnel du tracking d'Ã©vÃ©nement..."
          if curl -f -s -m 10 -X POST "https://makemelearn.fr/api/stats/track" \
              -H "Content-Type: application/json" \
              -d '{"event":"ci_test_event","value":1}' > /dev/null 2>&1; then
            echo "âœ… API Track accessible"
          else
            echo "âš ï¸ API Track non accessible (non-bloquant)"
          fi
          
          # ğŸ”¥ NOUVEAU: Test du contact form endpoint
          echo "ğŸ§ª Test optionnel du contact form..."
          if curl -f -s -m 15 -X POST "https://makemelearn.fr/api/contact" \
              -H "Content-Type: application/json" \
              -d '{"name":"CI Test","email":"test@example.com","subject":"Test from CI","message":"This is a test message from CI/CD pipeline"}' > /dev/null 2>&1; then
            echo "âœ… Contact API accessible"
          else
            echo "âš ï¸ Contact API non accessible (normal si email non configurÃ©)"
          fi
          
          # Test du formulaire de registrations
          echo "ğŸ§ª Test optionnel des registrations..."
          if curl -f -s -m 10 -X POST "https://makemelearn.fr/api/registrations" \
              -H "Content-Type: application/json" \
              -d '{"email":"ci-test@example.com","source":"ci_test"}' > /dev/null 2>&1; then
            echo "âœ… Registrations API accessible"
          else
            echo "âš ï¸ Registrations API non accessible (non-bloquant)"
          fi
          
          if [ $ERROR -eq 0 ]; then
            echo "ğŸ‰ Tous les tests post-dÃ©ploiement sont passÃ©s!"
            echo "ğŸŒ Frontend: https://makemelearn.fr"
            echo "ğŸ”§ API Health: https://makemelearn.fr/api/health"
            echo "ğŸ“Š API Stats: https://makemelearn.fr/api/stats/public"
            echo "ğŸ“ˆ API Track: https://makemelearn.fr/api/stats/track"
            echo "ğŸ“§ API Contact: https://makemelearn.fr/api/contact"
            echo "ğŸ“ API Registrations: https://makemelearn.fr/api/registrations"
          else
            echo "âŒ Certains tests ont Ã©chouÃ©"
            echo "âš ï¸ Cela peut Ãªtre dÃ» Ã  des dÃ©lais de dÃ©marrage - vÃ©rifiez manuellement"
          fi

  # Notification du statut
  notify:
    needs: [deploy, post-deploy-tests]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ DÃ©ploiement MakeMeLearn rÃ©ussi!"
            echo ""
            echo "ğŸ“Š RÃ‰SULTATS DU DÃ‰PLOIEMENT"
            echo "=========================="
            echo "ğŸŒ Site principal: https://makemelearn.fr"
            echo "ğŸ”§ API Health: https://makemelearn.fr/api/health"
            echo "ğŸ“Š API Stats: https://makemelearn.fr/api/stats/public"
            echo "ğŸ“ˆ API Track: https://makemelearn.fr/api/stats/track"
            echo "ğŸ“§ API Contact: https://makemelearn.fr/api/contact"
            echo "ğŸ“ API Register: https://makemelearn.fr/api/registrations"
            echo "ğŸ“… DÃ©ployÃ© le: $(date)"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "âœ… Tests post-dÃ©ploiement: ${{ needs.post-deploy-tests.result }}"
            echo ""
            echo "ğŸ”„ Prochaines Ã©tapes:"
            echo "- VÃ©rifiez que le site fonctionne"
            echo "- Configurez votre fichier .env sur le serveur pour les emails"
            echo "- Testez l'inscription ET le contact sur votre site"
            echo ""
            echo "ğŸ“‹ ROUTES API ACTIVES (Traefik stripprefix):"
            echo "- Traefik: /api/health â†’ API: /health"
            echo "- Traefik: /api/stats/* â†’ API: /stats/*"
            echo "- Traefik: /api/registrations â†’ API: /registrations"
            echo "- Traefik: /api/contact â†’ API: /contact (NOUVEAU)"
            echo ""
            echo "ğŸ“§ CONFIGURATION EMAIL NÃ‰CESSAIRE:"
            echo "- Configurez EMAIL_PROVIDER, SMTP_* ou SENDGRID_API_KEY"
            echo "- Le contact form ne fonctionnera qu'aprÃ¨s configuration email"
          else
            echo "âŒ DÃ©ploiement MakeMeLearn Ã©chouÃ©!"
            echo "Deploy result: ${{ needs.deploy.result }}"
            echo "Tests result: ${{ needs.post-deploy-tests.result }}"
            echo ""
            echo "ğŸ” VÃ©rifiez les logs des Ã©tapes prÃ©cÃ©dentes"
            exit 1
          fi