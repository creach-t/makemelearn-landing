name: Deploy MakeMeLearn Unified

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # Tests de l'API avec PostgreSQL
  test-api:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: makemelearn_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup test database
        run: |
          echo "ğŸ—„ï¸ Configuration de la base de donnÃ©es de test..."
          
          # Attendre que PostgreSQL soit prÃªt
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U test_user; then
              echo "âœ… PostgreSQL prÃªt"
              break
            fi
            echo "Attente PostgreSQL... ($i/30)"
            sleep 2
          done
          
          # CrÃ©er les tables de test
          echo "ğŸ“‹ CrÃ©ation des tables de test..."
          PGPASSWORD=test_password psql -h localhost -p 5432 -U test_user -d makemelearn_test << 'EOF'
          -- Script d'initialisation simplifiÃ© pour les tests
          CREATE TABLE IF NOT EXISTS registrations (
              id SERIAL PRIMARY KEY,
              email VARCHAR(255) UNIQUE NOT NULL,
              source VARCHAR(100) DEFAULT 'website',
              metadata JSONB DEFAULT '{}',
              is_verified BOOLEAN DEFAULT false,
              verification_token VARCHAR(255),
              created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
              unsubscribed_at TIMESTAMP WITH TIME ZONE DEFAULT NULL
          );

          CREATE TABLE IF NOT EXISTS stats (
              id SERIAL PRIMARY KEY,
              metric_name VARCHAR(100) NOT NULL,
              metric_value INTEGER DEFAULT 0,
              date DATE DEFAULT CURRENT_DATE,
              created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
              UNIQUE(metric_name, date)
          );

          -- Fonction pour incrÃ©menter les statistiques
          CREATE OR REPLACE FUNCTION increment_stat(stat_name VARCHAR(100), increment_value INTEGER DEFAULT 1)
          RETURNS void AS $$
          BEGIN
              INSERT INTO stats (metric_name, metric_value, date)
              VALUES (stat_name, increment_value, CURRENT_DATE)
              ON CONFLICT (metric_name, date)
              DO UPDATE SET 
                  metric_value = stats.metric_value + increment_value,
                  created_at = CURRENT_TIMESTAMP;
          END;
          $$ language 'plpgsql';

          -- InsÃ©rer quelques donnÃ©es de test
          INSERT INTO stats (metric_name, metric_value, date) VALUES 
              ('page_views', 0, CURRENT_DATE),
              ('api_calls', 0, CURRENT_DATE),
              ('registrations', 0, CURRENT_DATE)
          ON CONFLICT (metric_name, date) DO NOTHING;

          SELECT 'Tables crÃ©Ã©es avec succÃ¨s' as status;
          EOF
          
          echo "âœ… Base de donnÃ©es de test configurÃ©e"

      - name: Install API dependencies
        working-directory: ./api
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances API..."
          npm install
          
          # VÃ©rifier que les dÃ©pendances sont installÃ©es
          echo "âœ… DÃ©pendances installÃ©es:"
          npm list --depth=0 || echo "âš ï¸ Certaines dÃ©pendances peuvent Ãªtre manquantes"

      - name: Run API tests
        working-directory: ./api
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/makemelearn_test
        run: |
          echo "ğŸ§ª ExÃ©cution des tests API..."
          npm run test || echo "âš ï¸ Tests not configured yet - will be added later"
          npm run lint || echo "âš ï¸ Linting not configured yet - will be added later"

      - name: Test API startup and endpoints
        working-directory: ./api
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/makemelearn_test
          PORT: 3001
          CORS_ORIGIN: http://localhost:3001
        run: |
          echo "ğŸš€ Test de dÃ©marrage de l'API..."
          
          # DÃ©marrer l'API en arriÃ¨re-plan
          npm start &
          API_PID=$!
          
          # Fonction pour nettoyer en cas d'erreur
          cleanup() {
            echo "ğŸ§¹ Nettoyage..."
            kill $API_PID 2>/dev/null || true
            pkill -f "node.*server.js" 2>/dev/null || true
          }
          trap cleanup EXIT
          
          # Attendre que l'API dÃ©marre
          echo "ğŸ”„ DÃ©marrage de l'API..."
          API_STARTED=false
          for i in {1..45}; do
            if curl -f -s http://localhost:3001/health >/dev/null 2>&1; then
              echo "âœ… API dÃ©marrÃ©e avec succÃ¨s (tentative $i)"
              API_STARTED=true
              break
            fi
            echo "Attente dÃ©marrage API... ($i/45)"
            sleep 2
          done
          
          if [ "$API_STARTED" = "true" ]; then
            # Tester les endpoints critiques
            echo "ğŸ§ª Test des endpoints..."
            
            # Test health check
            echo "Testing /health endpoint..."
            if curl -f -s http://localhost:3001/health; then
              echo "âœ… Health check OK"
            else
              echo "âŒ Health check failed"
              exit 1
            fi
            
            # Test stats endpoint
            echo "Testing /api/stats/public endpoint..."
            if curl -f -s http://localhost:3001/api/stats/public; then
              echo "âœ… Stats endpoint OK"
            else
              echo "âŒ Stats endpoint failed"
              exit 1
            fi
            
            echo "ğŸ‰ Tous les tests d'endpoints sont passÃ©s!"
          else
            echo "âŒ API n'a pas pu dÃ©marrer dans les temps"
            echo "ğŸ“‹ Logs de debug:"
            jobs
            exit 1
          fi

  # Tests du frontend
  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install validation tools
        run: |
          echo "ğŸ“¦ Installation des outils de validation..."
          npm install -g html-validate
          npm install -g eslint

      - name: Validate HTML
        run: |
          echo "ğŸ” Validation HTML..."
          find . -name "*.html" -not -path "./node_modules/*" -not -path "./api/node_modules/*" | xargs html-validate

      - name: Validate JavaScript
        run: |
          echo "ğŸ” Validation JavaScript..."
          npx eslint script.js --no-eslintrc --config '{
            "env": { "browser": true, "es2021": true },
            "extends": "eslint:recommended",
            "rules": {
              "no-unused-vars": "warn",
              "no-undef": "warn"
            },
            "globals": {
              "console": "readonly",
              "fetch": "readonly",
              "document": "readonly",
              "window": "readonly",
              "navigator": "readonly"
            }
          }' || echo "âš ï¸ JS warnings detected but not blocking"

      - name: Check CSS syntax
        run: |
          echo "ğŸ” Validation CSS..."
          if [ -f "style.css" ]; then
            # Compter les accolades pour vÃ©rifier la syntaxe de base
            OPEN=$(grep -o "{" style.css | wc -l)
            CLOSE=$(grep -o "}" style.css | wc -l)
            if [ "$OPEN" -ne "$CLOSE" ]; then
              echo "âŒ Erreur: accolades CSS non Ã©quilibrÃ©es ($OPEN ouvertures, $CLOSE fermetures)"
              exit 1
            fi
            echo "âœ… CSS syntax OK ($OPEN/{$CLOSE} accolades)"
          fi

      - name: Check API configuration consistency
        run: |
          echo "ğŸ” VÃ©rification configuration API..."
          # VÃ©rifier que script.js utilise bien makemelearn.fr/api
          if grep -q "makemelearn.fr/api" script.js; then
            echo "âœ… API configuration correcte dans script.js"
          else
            echo "âŒ Configuration API manquante dans script.js"
            exit 1
          fi

      - name: Check files structure
        run: |
          echo "ğŸ” VÃ©rification de la structure des fichiers..."
          echo "ğŸ“„ Fichiers HTML trouvÃ©s:"
          find . -name "*.html" -not -path "./node_modules/*" | head -10
          echo "ğŸ“„ Fichiers CSS trouvÃ©s:"
          find . -name "*.css" -not -path "./node_modules/*"
          echo "ğŸ“„ Fichiers JS trouvÃ©s:"
          find . -name "*.js" -not -path "./node_modules/*" -not -path "./api/*"

  # DÃ©ploiement sur le serveur (seulement sur push vers main)
  deploy:
    needs: [test-api, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          debug: false
          script: |
            echo "ğŸš€ Starting MakeMeLearn deployment..."

            # Variables
            PROJECT_DIR="$HOME/projects/makemelearn-landing"
            BACKUP_DIR="$HOME/backups/makemelearn"
            DATE=$(date +%Y%m%d_%H%M%S)

            # CrÃ©er les dossiers si nÃ©cessaire
            mkdir -p "$BACKUP_DIR"

            # Aller dans le dossier du projet ou le crÃ©er
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“ CrÃ©ation du dossier projet..."
              mkdir -p ~/projects
              cd ~/projects
              git clone https://github.com/creach-t/makemelearn-landing.git
              cd makemelearn-landing
            else
              cd "$PROJECT_DIR"
            fi

            # Sauvegarder la configuration actuelle
            echo "ğŸ“¦ Sauvegarde de la configuration..."
            if [ -f ".env" ]; then
              cp .env "$BACKUP_DIR/.env.backup.$DATE"
              echo "âœ… .env sauvegardÃ©"
            fi

            # Sauvegarder la base de donnÃ©es si elle existe
            if docker compose ps -q postgres 2>/dev/null | grep -q .; then
              echo "ğŸ’¾ Sauvegarde de la base de donnÃ©es..."
              docker compose exec -T postgres pg_dump -U makemelearn_user makemelearn > "$BACKUP_DIR/db_backup_$DATE.sql" 2>/dev/null || echo "âš ï¸ Backup DB Ã©chouÃ© (normal si premiÃ¨re installation)"
            fi

            # ArrÃªter les services
            echo "â¹ï¸ ArrÃªt des services..."
            docker compose down --remove-orphans 2>/dev/null || echo "â„¹ï¸ Aucun service Ã  arrÃªter"

            # Mettre Ã  jour le code
            echo "ğŸ“¥ Mise Ã  jour du code..."
            git stash --include-untracked 2>/dev/null || true
            git fetch origin main
            git reset --hard origin/main

            # VÃ©rifier/crÃ©er le fichier .env
            if [ ! -f ".env" ]; then
              echo "âš ï¸ Fichier .env manquant, copie depuis l'exemple..."
              cp .env.example .env
              echo "ğŸ”§ ATTENTION: Configurez le fichier .env avec vos vraies valeurs!"
              echo "ğŸ”§ Utilisation de la configuration par dÃ©faut pour ce dÃ©ploiement"
            fi

            # CrÃ©er le network Traefik si nÃ©cessaire
            echo "ğŸŒ VÃ©rification du network Traefik..."
            docker network create traefik-public 2>/dev/null || echo "â„¹ï¸ Network traefik-public existe dÃ©jÃ "

            # DÃ©marrer les services
            echo "ğŸ”„ DÃ©marrage des services..."
            docker compose pull 2>/dev/null || echo "âš ï¸ Pull failed, continuing..."
            docker compose up -d --build

            # Attendre que les services soient prÃªts
            echo "â³ Attente que les services soient prÃªts..."
            sleep 30

            # VÃ©rifier les services
            echo "ğŸ” VÃ©rification des services..."
            docker compose ps

            echo "âœ… Deployment terminÃ©!"
            echo "ğŸŒ Site: https://makemelearn.fr"
            echo "ğŸ”§ API: https://makemelearn.fr/api/health"

  # Tests post-dÃ©ploiement
  post-deploy-tests:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Wait for services to be ready
        run: |
          echo "â³ Attente que les services soient complÃ¨tement prÃªts..."
          sleep 60

      - name: Test deployed services
        run: |
          echo "ğŸ” Test des services dÃ©ployÃ©s..."
          
          # Fonction pour tester une URL avec retry
          test_url() {
            local url=$1
            local name=$2
            local max_attempts=5
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ§ª Test $name (tentative $attempt/$max_attempts): $url"
              
              if curl -f -s -m 15 "$url" > /dev/null 2>&1; then
                echo "âœ… $name accessible"
                return 0
              elif [ $attempt -eq $max_attempts ]; then
                echo "âŒ $name non accessible aprÃ¨s $max_attempts tentatives"
                return 1
              else
                echo "â³ Nouvelle tentative dans 15s..."
                sleep 15
              fi
              
              ((attempt++))
            done
          }
          
          # Tests avec retry
          ERROR=0
          
          test_url "https://makemelearn.fr" "Frontend" || ERROR=1
          test_url "https://makemelearn.fr/api/health" "API Health" || ERROR=1
          test_url "https://makemelearn.fr/api/stats/public" "API Stats" || ERROR=1
          
          if [ $ERROR -eq 0 ]; then
            echo "ğŸ‰ Tous les tests post-dÃ©ploiement sont passÃ©s!"
            echo "ğŸŒ Frontend: https://makemelearn.fr"
            echo "ğŸ”§ API Health: https://makemelearn.fr/api/health"
            echo "ğŸ“Š API Stats: https://makemelearn.fr/api/stats/public"
          else
            echo "âŒ Certains tests ont Ã©chouÃ©"
            # Mais ne pas faire Ã©chouer le dÃ©ploiement pour des problÃ¨mes de timing
            echo "âš ï¸ Cela peut Ãªtre dÃ» Ã  des dÃ©lais de dÃ©marrage - vÃ©rifiez manuellement"
          fi

  # Notification du statut
  notify:
    needs: [deploy, post-deploy-tests]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ğŸ‰ DÃ©ploiement MakeMeLearn rÃ©ussi!"
            echo ""
            echo "ğŸ“Š RÃ‰SULTATS DU DÃ‰PLOIEMENT"
            echo "=========================="
            echo "ğŸŒ Site principal: https://makemelearn.fr"
            echo "ğŸ”§ API Health: https://makemelearn.fr/api/health"
            echo "ğŸ“Š API Stats: https://makemelearn.fr/api/stats/public"
            echo "ğŸ“… DÃ©ployÃ© le: $(date)"
            echo "ğŸ”— Commit: ${{ github.sha }}"
            echo "âœ… Tests post-dÃ©ploiement: ${{ needs.post-deploy-tests.result }}"
            echo ""
            echo "ğŸ”„ Prochaines Ã©tapes:"
            echo "- VÃ©rifiez que le site fonctionne"
            echo "- Configurez votre fichier .env sur le serveur"
            echo "- Testez l'inscription sur votre site"
          else
            echo "âŒ DÃ©ploiement MakeMeLearn Ã©chouÃ©!"
            echo "Deploy result: ${{ needs.deploy.result }}"
            echo "Tests result: ${{ needs.post-deploy-tests.result }}"
            echo ""
            echo "ğŸ” VÃ©rifiez les logs des Ã©tapes prÃ©cÃ©dentes"
            exit 1
          fi